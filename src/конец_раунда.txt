# конец_раунда
!The round ends, and all caused effects has been calculated

!gradually pass all current good and bad effects
i = -1
:loop
IF i < количество_врагов:
 i += 1
 if слабость[i] > 0: слабость[i] -= 1  
 if скованность[i] > 0:скованность[i] -= 1  
 if боль[i] > 0:боль[i] -= 1  
 if шаткость[i] > 0:шаткость[i] -= 1  
 if ошеломление[i] > 0:ошеломление[i] -= 1  
 if рассеянность[i] > 0:рассеянность[i] -= 1  
 if бешенство[i] > 0:бешенство[i] -= 1  
 if разгон[i] > 0:разгон[i] -= 1  
 if меткость[i] > 0:меткость[i] -= 1  
 if адреналин[i] > 0:адреналин[i] -= 1  
 if верткость[i] > 0:верткость[i] -= 1  
 if внимание[i] > 0:внимание[i] -= 1  
 jump 'loop'
END

!make damage and create status effect
IF $класс_врага[текущий] ! 'пешка':
 IF $тип_нанесенного_вреда = 'психический': 
  if тонкое_тело[$враг[текущий]] = 1: здоровье_врага[текущий] -= нанесенный_вред 
  if бесстрашный[$враг[текущий]] = 0: дух_врага[текущий] -= нанесенный_вред
  дух_игрока += нанесенный_вред/2
  jump 'loop4'
 END 
 IF $тип_нанесенного_вреда = 'дробящий': 
  if хрупкий[$враг[текущий]] = 1: здоровье_врага[текущий] -= нанесенный_вред 
  if безустали[$враг[текущий]] = 0: выносливость_врага[текущий] -= нанесенный_вред 
  if бесстрашный[$враг[текущий]] = 0: дух_врага[текущий] -= нанесенный_вред
  дух_игрока += нанесенный_вред/2
  jump 'loop4'
 END
 if бессмертный[$враг[текущий]] = 0: здоровье_врага[текущий] -= нанесенный_вред 
 if безустали[$враг[текущий]] = 0: выносливость_врага[текущий] -= нанесенный_вред 
 if бесстрашный[$враг[текущий]] = 0: дух_врага[текущий] -= нанесенный_вред
 дух_игрока += нанесенный_вред/2
END
:loop4
IF $наложение = 'слабость': 
 if слабость[текущий] <= длительность: слабость[текущий] = длительность
 if слабость[текущий] > длительность: слабость[текущий] += 1
END
IF $наложение = 'скованность': 
 if скованность[текущий] <= длительность: скованность[текущий] = длительность
 if скованность[текущий] > длительность: скованность[текущий] += 1
END
IF $наложение = 'боль': 
 if боль[текущий] <= длительность[i]: боль[текущий] = длительность
 if боль[текущий] > длительность[i]: боль[текущий] += 1
END
IF $наложение = 'шаткость': 
 if шаткость[текущий] <= длительность: шаткость[текущий] = длительность
 if шаткость[текущий] > длительность: шаткость[текущий] += 1
END
IF $наложение = 'ошеломление': 
 if ошеломление[текущий] <= длительность: ошеломление[текущий] = длительность
 if ошеломление[текущий] > длительность: ошеломление[текущий] += 1
END
IF $наложение = 'рассеянность': 
 if рассеянность[текущий] <= длительность: рассеянность[текущий] = длительность
 if рассеянность[текущий] > длительность: рассеянность[текущий] += 1
END
IF $наложение = 'бешенство': 
 if бешенство <= длительность: бешенство = длительность
 if бешенство > длительность: бешенство += 1
END
IF $наложение = 'разгон': 
 if разгон <= длительность: разгон = длительность
 if разгон > длительность: разгон += 1
END
IF $наложение = 'меткость': 
 if меткость <= длительность: меткость = длительность
 if меткость > длительность: меткость += 1
END  
IF $наложение = 'адреналин': 
 if адреналин <= длительность: адреналин = длительность
 if адреналин > длительность: адреналин += 1
END
IF $наложение = 'верткость': 
 if верткость <= длительность: верткость = длительность
 if верткость > длительность: верткость += 1
END
IF $наложение = 'внимание': 
 if внимание <= длительность: внимание = длительность
 if внимание > длительность: внимание += 1
END

if это_суперудар = 1: dynamic $спецэффект_суперудара[$суперудар[супер]]
это_суперудар = 0

i = 0
:loop1
IF i < количество_врагов:
 i += 1
 !Вред
 IF враг[i] = 1:
  IF $тип_нанесенного_вреда[i] = 'психический': 
   дух_игрока -= нанесенный_вред[i]
   дух_врага[i] += нанесенный_вред[i]/2
   jump 'loop2'
  END 
  IF $тип_нанесенного_вреда[i] = 'дробящий': 
   выносливость_игрока -= нанесенный_вред[i] 
   дух_игрока -= нанесенный_вред[i]
   дух_врага[i] += нанесенный_вред[i]/2
   jump 'loop2'
  END
  здоровье_игрока -= нанесенный_вред[i] 
  выносливость_игрока -= нанесенный_вред[i] 
  дух_игрока -= нанесенный_вред[i]
  дух_врага[i] += нанесенный_вред[i]/2
  :loop2
  !statuses 
  IF $наложение[i] = 'слабость': 
   if слабость[0] <= длительность[i]: слабость[0] = длительность[i]
   if слабость[0] > длительность[i]: слабость[0] += 1
  END
  IF $наложение[i] = 'скованность': 
   if скованность[0] <= длительность[i]: скованность[0] = длительность[i]
   if скованность[0] > длительность[i]: скованность[0] += 1
  END
  IF $наложение[i] = 'боль': 
   if боль[0] <= длительность[i]: боль[0] = длительность[i]
   if боль[0] > длительность[i]: боль[0] += 1
  END
  IF $наложение[i] = 'шаткость': 
   if шаткость[0] <= длительность[i]: шаткость[0] = длительность[i]
   if шаткость[0] > длительность[i]: шаткость[0] += 1
  END
  IF $наложение[i] = 'ошеломление': 
   if ошеломление[0] <= длительность[i]: ошеломление[0] = длительность[i]
   if ошеломление[0] > длительность[i]: ошеломление[0] += 1
  END
  IF $наложение[i] = 'рассеянность': 
   if рассеянность[0] <= длительность[i]: рассеянность[0] = длительность[i]
   if рассеянность[0] > длительность[i]: рассеянность[0] += 1
  END
  IF $наложение[i] = 'бешенство': 
   if бешенство[i] <= длительность[i]: бешенство[i] = длительность[i]
   if бешенство[i] > длительность[i]: бешенство[i] += 1
  END
  IF $наложение[i] = 'разгон': 
   if разгон[i] <= длительность[i]: разгон[i] = длительность[i]
   if разгон[i] > длительность[i]: разгон[i] += 1
  END
  IF $наложение[i] = 'меткость': 
   if меткость[i] <= длительность[i]: меткость[i] = длительность[i]
   if меткость[i] > длительность[i]: меткость[i] += 1
  END  
  IF $наложение[i] = 'адреналин': 
   if адреналин[i] <= длительность[i]: адреналин[i] = длительность[i]
   if адреналин[i] > длительность[i]: адреналин[i] += 1
  END
  IF $наложение[i] = 'верткость': 
   if верткость[i] <= длительность[i]: верткость[i] = длительность[i]
   if верткость[i] > длительность[i]: верткость[i] += 1
  END
  IF $наложение[i] = 'внимание': 
   if внимание[i] <= длительность[i]: внимание[i] = длительность[i]
   if внимание[i] > длительность[i]: внимание[i] += 1
  END
 END
 jump "loop1"
END

!check for enemy death
i = 0
:loop5
IF i < количество_врагов:
 i += 1
 IF враг[i] = 1:
  IF здоровье_врага[i] <= 0 and $класс_врага[i]!'пешка':   
   враг[i] = 0
   поверженные_враги += 1
   $трофей[тр] = $труп_моба_в_локацию[$враг[i]]
   труп[$враг[i]] += 1
   тр += 1   
   $действия_врага[i] = '<<$труп_врага[i]>><br>'
   jump 'loop5'
  END
  IF выносливость_врага[i] <= 0 and $класс_врага[i]!'пешка':   
   враг[i] = 0
   поверженные_враги += 1
   $трофей[тр] = $вырубленный_моб_в_локацию[$враг[i]]
   в_отключке[$враг[i]] += 1   
   тр += 1   
   $действия_врага[i] = '<<$тело_врага[i]>><br>'   
   jump 'loop5'
  END   
  IF дух_врага[i] <= 0 and $класс_врага[i]!'пешка':   
   враг[i] = 0
   поверженные_враги += 1
   $действия_врага[i] = '<<$беглец[i]>><br>' 
   jump 'loop5'
  END
  IF $состояние[i] = 'повержен':
   враг[i] = 0
   поверженные_враги += 1
   $трофей[тр] = $труп_моба_в_локацию[$враг[i]]
   труп[$враг[i]] += 1
   тр += 1   
   $действия_врага[i] = '<<$труп_врага[i]>><br>'
  END
 END
 jump 'loop5'
END

killvar 'нанесенный_вред'

!check for fight end
IF поверженные_враги = количество_врагов:
 $итог_боя = 'победа'
 !fixed, otherwise after a battle with one opponent the final spirit will always be equal to 5
 if количество_врагов > 2: дух_игрока = 5*количество_врагов
 gt 'конец_боя'
END
IF здоровье_игрока <= 0:
 $итог_боя = 'убит'
 gt 'конец_боя'
END
IF выносливость_игрока <= 0:
 $итог_боя = 'вырубился'
 gt 'конец_боя'
END
IF дух_игрока <= 0:
 $итог_боя = 'бегство'
 gt 'конец_боя'
END

GS 'боевое_меню'
GT 'боевой_интерфейс'
--- конец_раунда ---------------------------------

